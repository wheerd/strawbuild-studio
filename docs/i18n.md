# Internationalization (i18n)

This document describes Strawbaler's i18n setup and project-specific usage patterns.

## Supported Languages

- **English (en)** - Default
- **German (de)** - Full translation support

## Usage

### Translation Keys with Selector Syntax

Use the selector syntax for type-safe translation keys:

```typescript
import { useTranslation } from 'react-i18next'

function MyComponent() {
  const { t } = useTranslation()

  return (
    <div>
      <h1>{t($ => $.common.app.title)}</h1>
      <button>{t($ => $.common.actions.save)}</button>
    </div>
  )
}
```

### Formatters in Translations

Custom formatters are registered for measurements and can be used in translation strings:

```json
{
  "measurements": {
    "wallHeight": "Wall height: {{height, length}}",
    "totalArea": "Total area: {{area, area}}"
  }
}
```

```typescript
t($ => $.common.measurements.wallHeight, { height: 2500 }) // "Wall height: 2.5m"
```

**Available formatters:**

- `length` - Smart unit selection (mm, cm, m) with locale-aware decimals
- `lengthInMeters` - Always meters with 3 decimals
- `area` - Area in m²
- `volume` - Volume in m³
- `weight` - Weight in kg or tonnes
- `dimensions2D` - Cross-sections (e.g., "50mm × 100mm")

### Number Formatting in Code

For programmatic number formatting, use the `useFormatters()` hook:

```typescript
import { useFormatters } from '@/shared/i18n/useFormatters'

function MyComponent() {
  const { formatLength, formatArea } = useFormatters()

  return (
    <div>
      <Text>{formatLength(1234)}</Text>     {/* "1.234m" (EN) / "1,234m" (DE) */}
      <Text>{formatArea(1500000)}</Text>    {/* "1.50m²" (EN) / "1,50m²" (DE) */}
    </div>
  )
}
```

## Namespaces

Translations are organized by feature area:

| Namespace      | Purpose                                     |
| -------------- | ------------------------------------------- |
| `common`       | Shared UI elements, actions, units          |
| `welcome`      | Welcome modal content                       |
| `toolbar`      | Main toolbar and tools                      |
| `inspector`    | Property inspector panels                   |
| `tool`         | Tool configuration panels                   |
| `config`       | Configuration modal (materials, assemblies) |
| `overlay`      | Plan overlay features                       |
| `construction` | Construction views, tags, measurements      |
| `errors`       | Error and validation messages               |
| `viewer`       | 3D viewer controls and export               |

## Developer Workflows

### Adding New Translation Keys

1. **Use the key in your code:**

   ```typescript
   t($ => $.common.actions.delete)
   ```

2. **Extract keys and generate types:**

   ```bash
   pnpm i18n:update
   ```

3. **Translate in all locale files:**
   Edit `src/shared/i18n/locales/{en,de}/{namespace}.json`

### Adding a New Language

1. Copy English locale files:

   ```bash
   cp -r src/shared/i18n/locales/en src/shared/i18n/locales/fr
   ```

2. Translate all JSON files in the new directory

3. Import in `src/shared/i18n/config.ts`:

   ```typescript
   import commonFR from './locales/fr/common.json'

   // ... import all namespaces

   const resources = {
     en: {
       /* ... */
     },
     de: {
       /* ... */
     },
     fr: {
       common: commonFR
       // ... all namespaces
     }
   }
   ```

4. Update `i18next.config.ts`:

   ```typescript
   locales: ['en', 'de', 'fr']
   ```

5. Add to language switcher in `src/shared/components/LanguageSwitcher.tsx`

6. Regenerate types:
   ```bash
   pnpm i18n:interface
   ```

## npm Scripts

### `pnpm i18n:update`

**Most common workflow** - Extracts translation keys from source and regenerates types.

Runs `i18n:extract` then `i18n:interface`.

### `pnpm i18n:extract`

Scans source code for `t()` calls and updates locale JSON files.

- Adds new keys to all locales (English as source)
- Removes unused keys (unless matched by preserve patterns)
- Configured in `i18next.config.ts`

### `pnpm i18n:interface`

Generates TypeScript types from locale files.

Output: `src/@types/resources.d.ts`

## Configuration

### i18next.config.ts

```typescript
export default defineConfig({
  locales: ['en', 'de'],
  extract: {
    input: 'src/**/*.{ts,tsx}',
    ignore: '**/*.{d,test}.{ts,tsx}',
    output: 'src/shared/i18n/locales/{{language}}/{{namespace}}.json',
    functions: ['t', '*.t', 'i18next.t'],
    preservePatterns: [
      'errors:construction.*', // Dynamic error keys
      'tool:addOpening.presets.*', // Dynamic preset keys
      'config:*.defaults.*', // Dynamic config defaults
      'construction:tags.*' // Dynamic tag keys
      // ... patterns for keys constructed at runtime
    ],
    removeUnusedKeys: true
  }
})
```

**Preserve patterns** prevent removal of dynamically constructed keys:

```typescript
// Dynamic key - needs preserve pattern
const errorType = 'geometryProcessing'
t($ => $.errors.construction.error[errorType])
```

### Runtime Configuration (config.ts)

- **Fallback language:** English
- **Detection:** localStorage → browser navigator
- **Cache:** localStorage
- **Debug mode:** Development only (disabled in tests)

All custom formatters are registered using `i18n.services.formatter?.add()`.

## Locale-Aware Input Fields

The `LengthField` component accepts **both** `.` and `,` as decimal separators during typing, then formats to the user's locale on blur:

```typescript
<LengthField value={1250} onChange={setLength} unit="cm" />
```

- English user types `12,5` → formats to `12.5` on blur
- German user types `12.5` → formats to `12,5` on blur

## File Structure

```
src/shared/i18n/
├── config.ts              # i18next initialization & formatter registration
├── formatters.ts          # Locale-aware number formatting
├── useFormatters.ts       # React hook for formatters
├── numberParsing.ts       # Locale-aware number parsing (for inputs)
└── locales/
    ├── en/               # English (10 JSON files)
    └── de/               # German (10 JSON files)

src/@types/
├── i18next.d.ts          # TypeScript module augmentation
└── resources.d.ts        # Auto-generated types (do not edit)

i18next.config.ts         # Extraction configuration
```

## Number Formatting

| Locale  | Decimal | Thousands | Example    |
| ------- | ------- | --------- | ---------- |
| English | `.`     | `,`       | `1,234.56` |
| German  | `,`     | `.`       | `1.234,56` |

## Troubleshooting

**Types not updating after adding keys:**

```bash
pnpm i18n:update
```

**Dynamic key being removed:**
Add preserve pattern in `i18next.config.ts`:

```typescript
preservePatterns: ['your:key.pattern.*']
```

**Type errors after `git pull`:**

```bash
pnpm i18n:interface
```

---

**Libraries:** i18next ^25.7.3, react-i18next ^16.5.0, i18next-cli ^1.33.5
